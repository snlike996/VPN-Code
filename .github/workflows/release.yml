name: Release

on:
  push:
    tags: [ "v*" ]

permissions:
  contents: write

jobs:
  build_android_release:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app/pixi_vpn
    env:
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.logging.stacktrace=full"
      ANDROID_KEYSTORE_PATH: android/ci-release.keystore
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set release version
        run: echo "RELEASE_VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_ENV"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: gradle

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: "3.32.8"
          cache: true

      - name: Decode keystore
        run: echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/ci-release.keystore

      - name: Flutter pub get
        run: flutter pub get

      - name: Make gradlew executable
        run: chmod +x android/gradlew

      - name: Build APKs (release, split per ABI)
        run: flutter build apk --release --split-per-abi --build-name "$RELEASE_VERSION" --build-number "$GITHUB_RUN_NUMBER" --verbose

      - name: Build AAB (release)
        run: flutter build appbundle --release --build-name "$RELEASE_VERSION" --build-number "$GITHUB_RUN_NUMBER" --verbose

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: |
            app/pixi_vpn/build/app/outputs/flutter-apk/*.apk
            app/pixi_vpn/build/app/outputs/bundle/release/*.aab

  build_windows_release:
    runs-on: windows-latest
    defaults:
      run:
        working-directory: app/pixi_vpn
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set release version
        shell: pwsh
        run: |
          $version = $env:GITHUB_REF_NAME.TrimStart("v")
          "RELEASE_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: "3.32.8"
          cache: true

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Flutter pub get
        run: flutter pub get

      - name: Build Windows (x64)
        run: flutter build windows --release --build-name "$env:RELEASE_VERSION" --build-number "$env:GITHUB_RUN_NUMBER" --verbose

      - name: Stage x64 output
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path build/windows/x64/runner/Release | Out-Null
          Copy-Item -Path build/windows/runner/Release/* -Destination build/windows/x64/runner/Release -Recurse -Force

      - name: Detect arm64 support
        shell: pwsh
        run: |
          $help = flutter build windows -h | Out-String
          if ($help -match "target-platform") {
            "ARM64_SUPPORTED=true" | Out-File -FilePath $env:GITHUB_ENV -Append
          } else {
            "ARM64_SUPPORTED=false" | Out-File -FilePath $env:GITHUB_ENV -Append
          }

      - name: Build Windows (arm64)
        id: build_arm64
        if: env.ARM64_SUPPORTED == 'true'
        continue-on-error: true
        run: flutter build windows --release --target-platform=windows-arm64 --build-name "$env:RELEASE_VERSION" --build-number "$env:GITHUB_RUN_NUMBER" --verbose

      - name: Stage arm64 output
        if: env.ARM64_SUPPORTED == 'true'
        shell: pwsh
        run: |
          if ("${{ steps.build_arm64.outcome }}" -eq "success") {
            New-Item -ItemType Directory -Force -Path build/windows/arm64/runner/Release | Out-Null
            Copy-Item -Path build/windows/runner/Release/* -Destination build/windows/arm64/runner/Release -Recurse -Force
          }

      - name: Set arm64 flag
        shell: pwsh
        run: |
          if ("${{ steps.build_arm64.outcome }}" -eq "success") {
            "ARM64_BUILT=true" | Out-File -FilePath $env:GITHUB_ENV -Append
          } else {
            "ARM64_BUILT=false" | Out-File -FilePath $env:GITHUB_ENV -Append
          }

      - name: Prepare portable zips
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          $version = $env:RELEASE_VERSION
          Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath "artifacts/TSVPN-Windows-$version-x64.zip" -Force
          if ($env:ARM64_BUILT -eq "true") {
            Compress-Archive -Path build/windows/arm64/runner/Release/* -DestinationPath "artifacts/TSVPN-Windows-$version-arm64.zip" -Force
          }

      - name: Install Inno Setup
        run: choco install innosetup -y

      - name: Build installer (x64)
        shell: pwsh
        run: |
          $version = $env:RELEASE_VERSION
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer/windows/tsvpn.iss /DAppVersion=$version /DPlatform=x64 /DBuildDir=build\windows\x64\runner\Release /DAppExeName=pixi_vpn.exe

      - name: Build installer (arm64)
        if: env.ARM64_BUILT == 'true'
        shell: pwsh
        run: |
          $version = $env:RELEASE_VERSION
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer/windows/tsvpn.iss /DAppVersion=$version /DPlatform=arm64 /DBuildDir=build\windows\arm64\runner\Release /DAppExeName=pixi_vpn.exe

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: |
            app/pixi_vpn/artifacts/*.zip
            app/pixi_vpn/installer/windows/output/*.exe

  create_release:
    runs-on: ubuntu-latest
    needs: [build_android_release, build_windows_release]
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: dist/**
