name: Release

on:
  push:
    tags: [ "v*" ]

permissions:
  contents: write

jobs:
  build_android_release:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app/pixi_vpn
    env:
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.logging.stacktrace=full"
      ANDROID_KEYSTORE_PATH: android/ci-release.keystore
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set release version
        run: echo "RELEASE_VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_ENV"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: gradle

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: "3.32.8"
          cache: true

      - name: Decode keystore
        run: echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/ci-release.keystore

      - name: Flutter pub get
        run: flutter pub get

      - name: Make gradlew executable
        run: chmod +x android/gradlew

      - name: Build APKs (release, split per ABI)
        run: flutter build apk --release --split-per-abi --build-name "$RELEASE_VERSION" --build-number "$GITHUB_RUN_NUMBER" --verbose

      - name: Build AAB (release)
        run: flutter build appbundle --release --build-name "$RELEASE_VERSION" --build-number "$GITHUB_RUN_NUMBER" --verbose

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: |
            app/pixi_vpn/build/app/outputs/flutter-apk/*.apk
            app/pixi_vpn/build/app/outputs/bundle/release/*.aab

  build_windows_release:
    runs-on: windows-latest
    concurrency:
      group: windows-release-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: "3.32.8"
          cache: true

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Verify windows directory exists
        shell: pwsh
        run: |
          if (!(Test-Path "app/pixi_vpn/windows")) {
            Write-Error "windows/ directory not found. Run flutter create . locally and commit it."
            exit 1
          }

      - name: Set release version
        shell: pwsh
        run: |
          $version = $env:GITHUB_REF_NAME.TrimStart("v")
          "RELEASE_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Flutter pub get
        working-directory: app/pixi_vpn
        run: flutter pub get

      - name: Build Windows exe
        working-directory: app/pixi_vpn
        run: flutter build windows --release --verbose

      - name: Verify build output
        working-directory: app/pixi_vpn
        shell: pwsh
        run: |
          $candidates = @(
            "build/windows/x64/runner/Release",
            "build/windows/runner/Release"
          )
          $found = $null
          foreach ($path in $candidates) {
            if (Test-Path $path) {
              $found = $path
              break
            }
          }
          if ($null -eq $found) {
            Write-Error "Windows build output not found after build!"
            Get-ChildItem build/windows -Recurse -ErrorAction SilentlyContinue
            exit 1
          }
          $resolved = Resolve-Path -LiteralPath $found
          Get-ChildItem $resolved.Path
          "WIN_RELEASE_DIR=$($resolved.Path)" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Prepare x64 artifact
        working-directory: app/pixi_vpn
        shell: pwsh
        run: |
          $target = Resolve-Path -LiteralPath "build/windows/x64/runner/Release" -ErrorAction SilentlyContinue
          if ($null -eq $target) {
            New-Item -ItemType Directory -Force -Path build/windows/x64/runner/Release | Out-Null
            $target = Resolve-Path -LiteralPath "build/windows/x64/runner/Release"
          }
          $source = Resolve-Path -LiteralPath "$env:WIN_RELEASE_DIR"
          if ($source.Path -ne $target.Path) {
            Copy-Item -Path "$($source.Path)\*" `
              -Destination $target.Path `
              -Recurse -Force
          }

      - name: Prepare portable zip
        working-directory: app/pixi_vpn
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          $version = $env:RELEASE_VERSION
          Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath "artifacts/TSVPN-Windows-$version-x64.zip" -Force

      - name: Install Inno Setup
        run: choco install innosetup -y

      - name: Build installer (x64)
        working-directory: app/pixi_vpn
        shell: pwsh
        run: |
          $version = $env:RELEASE_VERSION
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer/windows/tsvpn.iss /DAppVersion=$version /DPlatform=x64 /DBuildDir=$env:WIN_RELEASE_DIR /DAppExeName=pixi_vpn.exe

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: |
            app/pixi_vpn/build/windows/x64/runner/Release/**
            app/pixi_vpn/build/windows/runner/Release/**
            app/pixi_vpn/artifacts/*.zip
            app/pixi_vpn/installer/windows/output/*.exe

  create_release:
    runs-on: ubuntu-latest
    needs: [build_android_release, build_windows_release]
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: dist/**
