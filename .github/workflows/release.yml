name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build_android_release:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app/pixi_vpn
    env:
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.logging.stacktrace=full"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: gradle

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: "3.32.8"
          cache: true

      - name: Resolve release version
        run: |
          RELEASE_VERSION="${GITHUB_REF_NAME#v}"
          echo "RELEASE_VERSION=$RELEASE_VERSION" >> "$GITHUB_ENV"

      - name: Flutter pub get
        run: flutter pub get

      - name: Make gradlew executable
        run: chmod +x android/gradlew

      - name: Build APKs (release, split per ABI)
        run: flutter build apk --release --split-per-abi --build-name "$RELEASE_VERSION" --build-number "$GITHUB_RUN_NUMBER" --verbose

      - name: Build AAB
        run: flutter build appbundle --release --build-name "$RELEASE_VERSION" --build-number "$GITHUB_RUN_NUMBER" --verbose

      - name: Rename Android artifacts
        run: |
          cd build/app/outputs/flutter-apk
          mv app-arm64-v8a-release.apk TSVPN-arm64-v8a-release.apk || true
          mv app-armeabi-v7a-release.apk TSVPN-armeabi-v7a-release.apk || true
          mv app-x86_64-release.apk TSVPN-x86_64-release.apk || true
          cd ../bundle/release
          mv app-release.aab TSVPN-release.aab || true

      - name: Stage Android artifacts
        run: |
          mkdir -p build/ci/android
          cp -f build/app/outputs/flutter-apk/TSVPN-*-release.apk build/ci/android/ || true
          cp -f build/app/outputs/bundle/release/TSVPN-release.aab build/ci/android/ || true
          ls -la build/ci/android

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: app/pixi_vpn/build/ci/android/*

  build_windows_release:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: "3.32.8"
          cache: true

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Verify windows directory exists
        shell: pwsh
        run: |
          if (!(Test-Path "app/pixi_vpn/windows")) {
            Write-Error "windows/ directory not found. Run flutter create . locally and commit it."
            exit 1
          }

      - name: Resolve release version
        shell: pwsh
        run: |
          $version = "$env:GITHUB_REF_NAME".TrimStart("v")
          "RELEASE_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Flutter pub get
        working-directory: app/pixi_vpn
        run: flutter pub get

      - name: Build Windows exe
        working-directory: app/pixi_vpn
        run: flutter build windows --release --build-name "$env:RELEASE_VERSION" --build-number "$env:GITHUB_RUN_NUMBER" --verbose

      - name: Verify build output
        working-directory: app/pixi_vpn
        shell: pwsh
        run: |
          $candidates = @(
            "build/windows/x64/runner/Release",
            "build/windows/runner/Release"
          )
          $found = $null
          foreach ($path in $candidates) {
            if (Test-Path $path) {
              $found = $path
              break
            }
          }
          if ($null -eq $found) {
            Write-Error "Windows build output not found after build!"
            Get-ChildItem build/windows -Recurse -ErrorAction SilentlyContinue
            exit 1
          }
          $resolved = Resolve-Path -LiteralPath $found
          Get-ChildItem $resolved.Path
          "WIN_RELEASE_DIR=$($resolved.Path)" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Stage TSVPN.exe
        working-directory: app/pixi_vpn
        shell: pwsh
        run: |
          $targetPath = "build/ci/windows"
          New-Item -ItemType Directory -Force -Path $targetPath | Out-Null
          $exePath = Join-Path $env:WIN_RELEASE_DIR "pixi_vpn.exe"
          if (!(Test-Path $exePath)) {
            $exePath = (Get-ChildItem $env:WIN_RELEASE_DIR -Filter *.exe | Select-Object -First 1).FullName
          }
          if ([string]::IsNullOrWhiteSpace($exePath)) {
            Write-Error "No Windows exe found in $env:WIN_RELEASE_DIR"
            exit 1
          }
          Copy-Item -Path $exePath -Destination "$targetPath/TSVPN.exe" -Force

      - name: Build installer (x64)
        working-directory: app/pixi_vpn
        shell: pwsh
        run: |
          if (!(Test-Path "installer/windows/tsvpn.iss")) {
            Write-Host "Installer script missing, skipping."
            exit 0
          }
          choco install innosetup -y
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer/windows/tsvpn.iss /DAppVersion=$env:RELEASE_VERSION /DPlatform=x64 /DBuildDir=$env:WIN_RELEASE_DIR /DAppExeName=pixi_vpn.exe
          if (Test-Path "installer/output") {
            $installer = Get-ChildItem installer/output -Filter *.exe | Select-Object -First 1
            if ($null -ne $installer) {
              Copy-Item -Path $installer.FullName -Destination build/ci/windows/TSVPN-Setup-x64.exe -Force
            }
          }

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: app/pixi_vpn/build/ci/windows/*.exe

  publish_release:
    runs-on: ubuntu-latest
    needs: [build_android_release, build_windows_release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Prepare release body
        run: |
          VERSION="${GITHUB_REF_NAME}"
          cat <<EOF > release_notes.md
          ${VERSION}

          üì± Android

          * TSVPN-arm64-v8a-release.apkÔºàÊé®ËçêÔºåÂ§ßÂ§öÊï∞ÊâãÊú∫Ôºâ
          * TSVPN-armeabi-v7a-release.apk
          * TSVPN-x86_64-release.apkÔºàÊ®°ÊãüÂô®Ôºâ
          * TSVPN-release.aabÔºàGoogle PlayÔºâ

          üñ• Windows

          * TSVPN-Setup-x64.exeÔºàÊé®ËçêÔºåÂÆâË£ÖÁâàÔºâ
          * TSVPN.exeÔºàÁªøËâ≤ÁâàÔºâ
          EOF

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          body_path: release_notes.md
          files: |
            dist/android-release/TSVPN-*-release.apk
            dist/android-release/TSVPN-release.aab
            dist/windows-release/TSVPN-Setup-x64.exe
            dist/windows-release/TSVPN.exe
