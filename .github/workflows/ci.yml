name: CI

on:
  push:
    branches: ["main", "master"]
  pull_request:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_android:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app/pixi_vpn
    env:
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.logging.stacktrace=full"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: gradle

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: "3.32.8"
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Make gradlew executable
        run: chmod +x android/gradlew

      - name: Build APKs (release, split per ABI)
        run: flutter build apk --release --split-per-abi --verbose

      - name: Build AAB (release)
        run: flutter build appbundle --release --verbose

      - name: Rename APKs
        run: |
          cd build/app/outputs/flutter-apk
          mv app-arm64-v8a-release.apk TSVPN-arm64-v8a.apk || true
          mv app-armeabi-v7a-release.apk TSVPN-armeabi-v7a.apk || true
          mv app-x86_64-release.apk TSVPN-x86_64.apk || true

      - name: Stage Android artifacts
        run: |
          mkdir -p build/ci/android
          for f in build/app/outputs/flutter-apk/TSVPN-*.apk; do
            if [ -f "$f" ]; then
              cp "$f" build/ci/android/
            fi
          done
          if [ -f build/app/outputs/bundle/release/app-release.aab ]; then
            cp build/app/outputs/bundle/release/app-release.aab build/ci/android/TSVPN-release.aab
          fi
          ls -la build/ci/android

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: app/pixi_vpn/build/ci/android/*

  build_windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: "3.32.8"
          cache: true

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Verify windows directory exists
        shell: pwsh
        run: |
          if (!(Test-Path "app/pixi_vpn/windows")) {
            Write-Error "windows/ directory not found. Run flutter create . locally and commit it."
            exit 1
          }

      - name: Flutter pub get
        working-directory: app/pixi_vpn
        run: flutter pub get

      - name: Build Windows exe
        working-directory: app/pixi_vpn
        run: flutter build windows --release --verbose

      - name: Verify build output
        working-directory: app/pixi_vpn
        shell: pwsh
        run: |
          $candidates = @(
            "build/windows/x64/runner/Release",
            "build/windows/runner/Release"
          )
          $found = $null
          foreach ($path in $candidates) {
            if (Test-Path $path) {
              $found = $path
              break
            }
          }
          if ($null -eq $found) {
            Write-Error "Windows build output not found after build!"
            Get-ChildItem build/windows -Recurse -ErrorAction SilentlyContinue
            exit 1
          }
          $resolved = Resolve-Path -LiteralPath $found
          Get-ChildItem $resolved.Path
          "WIN_RELEASE_DIR=$($resolved.Path)" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Stage TSVPN.exe
        working-directory: app/pixi_vpn
        shell: pwsh
        run: |
          $targetPath = "build/ci/windows"
          New-Item -ItemType Directory -Force -Path $targetPath | Out-Null
          $exePath = Join-Path $env:WIN_RELEASE_DIR "TSVPN.exe"
          if (!(Test-Path $exePath)) {
            $exePath = (Get-ChildItem $env:WIN_RELEASE_DIR -Filter *.exe | Select-Object -First 1).FullName
          }
          if ([string]::IsNullOrWhiteSpace($exePath)) {
            Write-Error "No Windows exe found in $env:WIN_RELEASE_DIR"
            exit 1
          }
          Copy-Item -Path $exePath -Destination "$targetPath/TSVPN.exe" -Force

      - name: Download VC++ Runtime
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $outDir = "app/pixi_vpn/installer/windows/redist"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          function Download-WithRetry($url, $outFile) {
            $max = 5
            for ($i = 1; $i -le $max; $i++) {
              try {
                Write-Host "Downloading $url (attempt $i/$max)"
                curl.exe -L --retry 3 --retry-delay 2 --connect-timeout 15 --max-time 300 -o $outFile $url
                if (Test-Path $outFile) {
                  return
                }
              } catch {
                if ($i -eq $max) { throw }
                Start-Sleep -Seconds (2 * $i)
              }
            }
            throw "Failed to download $url"
          }
          $x64File = Join-Path $outDir "vc_redist.x64.exe"
          $arm64File = Join-Path $outDir "vc_redist.arm64.exe"
          Download-WithRetry "https://aka.ms/vs/17/release/vc_redist.x64.exe" $x64File
          Download-WithRetry "https://aka.ms/vs/17/release/vc_redist.arm64.exe" $arm64File
          Get-Item $x64File | Format-List
          Get-Item $arm64File | Format-List

      - name: Build installer (x64)
        working-directory: app/pixi_vpn
        shell: pwsh
        run: |
          if (!(Test-Path "installer/windows/tsvpn.iss")) {
            Write-Host "Installer script missing, skipping."
            exit 0
          }
          choco install innosetup -y
          $version = "0.0.0.$env:GITHUB_RUN_NUMBER"
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer/windows/tsvpn.iss /DAppVersion=$version /DPlatform=x64 /DBuildDir=$env:WIN_RELEASE_DIR /DAppExeName=TSVPN.exe
          if (Test-Path "installer/output") {
            Copy-Item -Path installer/output/*.exe -Destination build/ci/windows/ -Force
          }

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: app/pixi_vpn/build/ci/windows/*.exe
